<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VOIDLINK // OBLIVION_STATION</title>
    <style>
        :root { --void: #050505; --beige: #E3DAC9; --green: #00FF41; --red: #FF3131; --blue: #00BFFF; --purple: #BF5FFF; --orange: #FF8C00; --slate: #808080; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'SF Mono', 'Fira Code', monospace; }
        body { background: var(--void); color: var(--beige); height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        
        #ui-frame { width: 95vw; height: 92vh; background: rgba(227, 218, 201, 0.03); border: 1px solid rgba(227, 218, 201, 0.1); backdrop-filter: blur(25px); display: flex; flex-direction: column; padding: 25px; border-radius: 20px; position: relative; }
        .header { display: flex; justify-content: space-between; font-size: 10px; letter-spacing: 2px; border-bottom: 1px solid rgba(227, 218, 201, 0.1); padding-bottom: 15px; }
        
        #game-grid { display: grid; grid-template-columns: 1fr 280px; gap: 20px; flex-grow: 1; margin-top: 20px; }
        #pilot-box { border: 1px solid rgba(227, 218, 201, 0.1); position: relative; background: rgba(0,0,0,0.4); border-radius: 12px; overflow: hidden; cursor: crosshair; }
        #target-zone { position: absolute; left: 0; width: 100%; height: 70px; background: rgba(0, 255, 65, 0.08); border-top: 2px solid var(--green); border-bottom: 2px solid var(--green); pointer-events: none; }
        
        #side-panel { display: flex; flex-direction: column; gap: 20px; }
        .panel-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(227, 218, 201, 0.1); border-radius: 10px; padding: 15px; }
        
        #hex-display { font-size: 40px; font-weight: 900; color: #fff; text-align: center; margin: 10px 0; transition: color 0.3s; }
        #input-preview { font-size: 14px; color: var(--green); text-align: center; min-height: 20px; letter-spacing: 4px; }
        .leaderboard-title { font-size: 9px; opacity: 0.5; margin-bottom: 10px; text-transform: uppercase; }
        
        #heat-meter { width: 100%; height: 4px; background: rgba(255,255,255,0.05); margin-top: 15px; }
        #heat-bar { height: 100%; width: 0%; background: var(--red); transition: 0.1s; }
        
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--void); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border-radius: 20px; }
        .input-group { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 20px; }
        .pilot-input { background: transparent; border: 1px solid rgba(227, 218, 201, 0.2); color: var(--beige); padding: 12px; text-align: center; outline: none; width: 220px; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; }
        
        .btn { padding: 15px 35px; border: 1px solid var(--beige); background: none; color: var(--beige); cursor: pointer; text-transform: uppercase; font-size: 11px; margin: 10px; transition: 0.3s; letter-spacing: 2px; }
        .btn:hover { background: var(--beige); color: var(--void); }
        
        .warning { animation: pulse 0.3s infinite; }
        @keyframes pulse { 0%,100% { background: transparent; } 50% { background: rgba(255,49,49,0.1); } }

        /* BOSS OVERLAY */
        #boss-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5,5,5,0.94); border-radius: 12px; z-index: 10; flex-direction: column; align-items: center; justify-content: center; cursor: crosshair; }
        #boss-overlay.active { display: flex; }
        #boss-label { font-size: 10px; letter-spacing: 5px; margin-bottom: 8px; }
        #boss-sub { font-size: 8px; color: var(--beige); opacity: 0.35; letter-spacing: 2px; margin-top: 10px; }
        
        #surge-hint { font-size: 10px; letter-spacing: 3px; opacity: 0.6; margin-bottom: 16px; position: absolute; bottom: 60px; color: var(--green); }
    </style>
</head>
<body>

<div id="ui-frame">
    <div id="overlay">
        <h1 style="letter-spacing:15px;font-weight:900;font-size:40px;">V O I D L I N K</h1>
        <p style="opacity:0.5;font-size:9px;margin-top:10px;letter-spacing:3px;">OBLIVION_STATION // PROTOCOL 2026</p>
        <div id="session-stats" style="margin:20px 0;display:none;">
            <p id="last-uptime" style="font-size:48px;color:var(--red);font-weight:bold;"></p>
        </div>
        <div class="input-group" id="login-fields">
            <input type="text" id="p1-input" class="pilot-input" placeholder="PILOT_01">
            <input type="text" id="p2-input" class="pilot-input" placeholder="PILOT_02">
        </div>
        <div style="display:flex;flex-wrap:wrap;justify-content:center;margin-top:20px;">
            <button class="btn" onclick="start()">START SESSION</button>
            <button id="share-insta" class="btn" style="display:none;border-color:var(--slate);" onclick="genInstaCard()">GENERATE CARD</button>
        </div>
        <p style="font-size: 9px; color: var(--green); margin-top: 40px; opacity: 0.6; letter-spacing: 2px;">DESIGNED FOR THE FUTURE @VoidLink</p>
    </div>

    <div class="header">
        <div>PILOTS: <span id="pilot-name-ui">---</span></div>
        <div id="boss-badge" style="display:none;font-size:10px;letter-spacing:3px;"></div>
        <div>UPTIME: <span id="time-ui">0.0</span>s</div>
    </div>

    <div id="game-grid">
        <div id="pilot-box">
            <div id="target-zone"></div>
            <canvas id="waveCanvas"></canvas>

            <div id="boss-overlay">
                <div id="boss-label">BOSS</div>
                <canvas id="boss-canvas"></canvas>
                <div id="surge-hint" style="display:none;"></div>
                <div id="boss-sub">---</div>
            </div>
        </div>

        <div id="side-panel">
            <div id="decoder-card" class="panel-card">
                <div id="side-title" class="leaderboard-title">DECODER INPUT</div>
                <div id="hex-display">----</div>
                <div id="input-preview"></div>
                <div id="heat-meter"><div id="heat-bar"></div></div>
            </div>
            <div class="panel-card" style="flex-grow:1;">
                <div class="leaderboard-title">STATION LOG</div>
                <div id="sync-info" style="font-size: 11px; margin-bottom: 10px;">SYNC: 0/3</div>
                <div id="boss-count-ui" style="font-size: 11px; color: var(--green);">BOSS_CLEARED: 0</div>
                <div id="leaderboard-list" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>
</div>

<canvas id="instaCanvas" width="1080" height="1920" style="display:none;"></canvas>

<script>
const canvas = document.getElementById('waveCanvas');
const ctx = canvas.getContext('2d');
const zone = document.getElementById('target-zone');
const bossOv = document.getElementById('boss-overlay');
const bCanvas = document.getElementById('boss-canvas');
const bCtx = bCanvas.getContext('2d');

let running = false, time = 0, heat = 0, mouseY = 150, waveY = 150;
let hex = '', input = '', playerName = '';
let attempts = parseInt(localStorage.getItem('void_attempts_v5') || '0');
let bossCleared = 0;
let codesSolved = 0;
let inBoss = false;
let bossRAF = null;
let currentBoss = '';

const BOSS_TYPES = ['OBLIVION', 'SURGE'];
const BOSS_COLOR = { OBLIVION: 'var(--red)', SURGE: '#FF69B4' };

// --- LOGICA BOSS OBLIVION (ANELLI) ---
let rings = [];
class Ring {
    constructor(i) {
        this.radius = 40 + i * 35;
        this.angle = Math.random() * Math.PI * 2;
        this.speed = (0.03 + i * 0.01) * (Math.random() > 0.5 ? 1 : -1);
        this.target = Math.random() * Math.PI * 2;
        this.locked = false;
    }
    update() { if (!this.locked) this.angle += this.speed; }
    draw(cx, cy) {
        bCtx.beginPath(); bCtx.arc(cx, cy, this.radius, 0, Math.PI*2);
        bCtx.strokeStyle = 'rgba(227,218,201,0.05)'; bCtx.lineWidth = 6; bCtx.stroke();
        bCtx.beginPath(); bCtx.arc(cx, cy, this.radius, this.target - 0.2, this.target + 0.2);
        bCtx.strokeStyle = this.locked ? 'var(--green)' : 'var(--beige)'; bCtx.lineWidth = 10; bCtx.stroke();
        if (!this.locked) {
            bCtx.beginPath(); bCtx.arc(cx, cy, this.radius, this.angle - 0.1, this.angle + 0.1);
            bCtx.strokeStyle = '#fff'; bCtx.lineWidth = 12; bCtx.stroke();
        }
    }
}

// --- LOGICA BOSS SURGE (HOLD) ---
let surgeHeld = false, surgeAngle = 0, surgeTarget = 0, surgeSpeed = 1.5;

function start() {
    const p1 = document.getElementById('p1-input').value.trim();
    const p2 = document.getElementById('p2-input').value.trim();
    if (!p1 || !p2) return;
    playerName = p1 + ' + ' + p2;
    canvas.width = document.getElementById('pilot-box').clientWidth;
    canvas.height = document.getElementById('pilot-box').clientHeight;
    bCanvas.width = 400; bCanvas.height = 400;

    attempts++;
    localStorage.setItem('void_attempts_v5', attempts);
    
    time = 0; heat = 0; codesSolved = 0; bossCleared = 0;
    running = true; inBoss = false;
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('boss-count-ui').innerText = "BOSS_CLEARED: 0";
    document.getElementById('sync-info').innerText = "SYNC: 0/3";
    
    genHex();
    loop();
}

function loop() {
    if (!running || inBoss) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    time += 0.016; 
    heat += 0.08;
    
    let targetY = (canvas.height / 2 - 35) + (Math.sin(time * 1.5) * 80);
    zone.style.top = targetY + 'px';
    waveY += (mouseY - waveY) * 0.15;

    if (Math.abs(waveY - (targetY + 35)) > 45) {
        heat += 0.4;
        document.getElementById('ui-frame').classList.add('warning');
    } else {
        document.getElementById('ui-frame').classList.remove('warning');
    }

    ctx.beginPath(); ctx.strokeStyle = "#E3DAC9"; ctx.lineWidth = 2;
    for (let x = 0; x < canvas.width; x += 10) {
        let y = waveY + Math.sin(x * 0.02 + time * 4) * 15;
        x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();

    document.getElementById('time-ui').innerText = time.toFixed(1);
    document.getElementById('heat-bar').style.width = heat + '%';

    if (heat >= 100) endGame();
    else requestAnimationFrame(loop);
}

function triggerBoss() {
    inBoss = true;
    currentBoss = BOSS_TYPES[Math.floor(Math.random() * BOSS_TYPES.length)];
    bossOv.classList.add('active');
    document.getElementById('boss-label').innerText = "âš  " + currentBoss;
    document.getElementById('boss-label').style.color = BOSS_COLOR[currentBoss];
    document.getElementById('boss-badge').style.display = 'block';
    document.getElementById('boss-badge').innerText = currentBoss + '_SEQUENCE';
    document.getElementById('boss-badge').style.color = BOSS_COLOR[currentBoss];

    if (currentBoss === 'OBLIVION') {
        rings = [new Ring(0), new Ring(1), new Ring(2), new Ring(3)];
        document.getElementById('boss-sub').innerText = "LOCK ALL RINGS";
    } else {
        surgeAngle = 0; surgeTarget = Math.random() * 360;
        document.getElementById('boss-sub').innerText = "HOLD & RELEASE IN ZONE";
        document.getElementById('surge-hint').style.display = 'block';
    }
    bossLoop();
}

function bossLoop() {
    if (!inBoss) return;
    bCtx.clearRect(0, 0, bCanvas.width, bCanvas.height);
    const cx = bCanvas.width / 2, cy = bCanvas.height / 2;

    if (currentBoss === 'OBLIVION') {
        rings.forEach(r => { r.update(); r.draw(cx, cy); });
    } else {
        surgeAngle = (surgeAngle + surgeSpeed) % 360;
        // Pista
        bCtx.beginPath(); bCtx.arc(cx, cy, 120, 0, Math.PI*2);
        bCtx.strokeStyle = 'rgba(255,255,255,0.05)'; bCtx.lineWidth = 15; bCtx.stroke();
        // Target
        let tRad = surgeTarget * Math.PI / 180;
        bCtx.beginPath(); bCtx.arc(cx, cy, 120, tRad - 0.3, tRad + 0.3);
        bCtx.strokeStyle = 'var(--green)'; bCtx.lineWidth = 15; bCtx.stroke();
        // Cursore
        let cRad = surgeAngle * Math.PI / 180;
        bCtx.beginPath(); bCtx.arc(cx + Math.cos(cRad)*120, cy + Math.sin(cRad)*120, 8, 0, Math.PI*2);
        bCtx.fillStyle = surgeHeld ? BOSS_COLOR.SURGE : '#fff'; bCtx.fill();
    }
    bossRAF = requestAnimationFrame(bossLoop);
}

function bossAction() {
    if (currentBoss === 'OBLIVION') {
        const active = rings.find(r => !r.locked);
        if (active) {
            let diff = Math.abs((active.angle % (Math.PI*2)) - (active.target % (Math.PI*2)));
            if (diff > Math.PI) diff = Math.PI*2 - diff;
            if (diff < 0.28) {
                active.locked = true;
                if (rings.every(r => r.locked)) exitBoss(true);
            } else exitBoss(false);
        }
    } else { surgeHeld = true; }
}

function exitBoss(success) {
    inBoss = false;
    cancelAnimationFrame(bossRAF);
    bossOv.classList.remove('active');
    document.getElementById('boss-badge').style.display = 'none';
    document.getElementById('surge-hint').style.display = 'none';
    
    if (success) {
        bossCleared++;
        codesSolved = 0;
        document.getElementById('boss-count-ui').innerText = `BOSS_CLEARED: ${bossCleared}`;
        document.getElementById('sync-info').innerText = "SYNC: 0/3";
        genHex();
        loop();
    } else { endGame(); }
}

function endGame() {
    running = false;
    document.getElementById('overlay').style.display = 'flex';
    document.getElementById('session-stats').style.display = 'block';
    document.getElementById('last-uptime').innerText = time.toFixed(1) + 's';
    document.getElementById('share-insta').style.display = 'inline-block';
    document.getElementById('login-fields').style.display = 'none';
}

function genHex() {
    hex = Math.random().toString(16).toUpperCase().substring(2, 6);
    document.getElementById('hex-display').innerText = hex;
    input = ''; document.getElementById('input-preview').innerText = '';
}

// Input Eventi
window.addEventListener('mousemove', e => {
    const rect = canvas.getBoundingClientRect();
    mouseY = e.clientY - rect.top;
});
window.addEventListener('mousedown', () => { if(inBoss) bossAction(); });
window.addEventListener('mouseup', () => {
    if (inBoss && currentBoss === 'SURGE' && surgeHeld) {
        surgeHeld = false;
        let diff = Math.abs((surgeAngle % 360) - (surgeTarget % 360));
        if (diff > 180) diff = 360 - diff;
        exitBoss(diff < 20);
    }
});

// FIX: Gestione Backspace e limite caratteri
window.addEventListener('keydown', e => {
    if (!running || inBoss) return;
    
    // Gestione Backspace
    if (e.key === 'Backspace') {
        input = input.slice(0, -1);
        document.getElementById('input-preview').innerText = input;
        return;
    }

    const k = e.key.toUpperCase();
    if ("0123456789ABCDEF".includes(k)) {
        // Limite a 4 caratteri
        if (input.length < 4) {
            input += k; 
            document.getElementById('input-preview').innerText = input;
            if (input === hex) {
                heat = Math.max(0, heat - 35);
                codesSolved++;
                document.getElementById('sync-info').innerText = `SYNC: ${codesSolved}/3`;
                if (codesSolved >= 3) triggerBoss();
                else genHex();
            }
        }
    }
});

// --- VECCHIA CARD ESTETICA ADATTATA ---

function genInstaCard() {

    const iCanvas = document.getElementById('instaCanvas');

    const iCtx = iCanvas.getContext('2d');

    

    // Background con gradiente

    const grad = iCtx.createRadialGradient(540, 960, 100, 540, 960, 1200);

    grad.addColorStop(0, '#1a1a1a'); grad.addColorStop(1, '#050505');

    iCtx.fillStyle = grad; iCtx.fillRect(0, 0, 1080, 1920);

    

    // Linee curve decorative

    iCtx.strokeStyle = 'rgba(227, 218, 201, 0.03)';

    for(let i=0; i<1080; i+=60) {

        iCtx.beginPath(); iCtx.moveTo(i, 0);

        iCtx.bezierCurveTo(i+50, 600, i-50, 1200, i, 1920); iCtx.stroke();

    }

    

    // Bordo

    iCtx.strokeStyle = '#808080'; iCtx.lineWidth = 2; iCtx.strokeRect(50, 50, 980, 1820);

    

    // Titoli

    iCtx.fillStyle = '#E3DAC9'; iCtx.font = 'bold 90px Arial'; iCtx.fillText('VOIDLINK', 100, 200);

    iCtx.fillStyle = '#00FF41'; iCtx.font = '22px Courier New'; iCtx.fillText('STABILITY TEST // OBLIVION PROTOCOL // 2026', 100, 250);

    

    // Box Tempo

    iCtx.fillStyle = 'rgba(255, 255, 255, 0.02)'; iCtx.fillRect(100, 380, 880, 550);

    iCtx.strokeStyle = 'rgba(227, 218, 201, 0.1)'; iCtx.strokeRect(100, 380, 880, 550);

    iCtx.fillStyle = '#808080'; iCtx.font = 'bold 35px Arial'; iCtx.fillText('CORE_UPTIME', 150, 470);

    

    iCtx.fillStyle = '#FFF'; iCtx.font = '900 280px Arial';

    const sVal = time.toFixed(1); iCtx.fillText(sVal, 150, 780);

    const offX = iCtx.measureText(sVal).width;

    iCtx.font = '100px Arial'; iCtx.fillText('s', 160 + offX, 780);

    

    // Dati Sessione

    const drawData = (l, v, y) => {

        iCtx.fillStyle = 'rgba(227, 218, 201, 0.5)'; iCtx.font = '20px Courier New'; iCtx.fillText(l, 100, y);

        iCtx.fillStyle = '#E3DAC9'; iCtx.font = 'bold 50px Arial'; iCtx.fillText(v, 100, y + 60);

    };

    drawData('PILOTS', playerName.toUpperCase(), 1050);

    drawData('BOSS_CLEARED', bossCleared.toString().padStart(3, '0'), 1250);

    drawData('TOTAL_SESSIONS', attempts.toString().padStart(3, '0'), 1450);

    

    // Radar Decor

    iCtx.strokeStyle = 'rgba(128, 128, 128, 0.5)';

    iCtx.beginPath(); iCtx.arc(850, 1350, 120, 0, Math.PI*2); iCtx.stroke();

    iCtx.moveTo(850, 1230); iCtx.lineTo(850, 1470); iCtx.moveTo(730, 1350); iCtx.lineTo(970, 1350); iCtx.stroke();



    // Footer

    iCtx.fillStyle = '#00FF41'; iCtx.font = 'bold 60px Arial'; iCtx.fillText('@VOIDLINK', 100, 1750);

    

    const link = document.createElement('a'); link.download = `VoidLink_Card.png`;

    link.href = iCanvas.toDataURL('image/png'); link.click();

}

</script>
</body>
</html>
